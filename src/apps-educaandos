#!/bin/bash

#Variables

gitfolder=/home/$USER/guadalinex
gitguadalinex=https://github.com/aosucas499/guadalinex
branch=main
background=/usr/share/backgrounds/educaandos_wallpaper.png
bgsize=$(du $background|cut -f 1)

# Función que comprueba que el usuario que lanza la app tiene derechos admin.

function adminGroup {

        if groups $USER | grep -q ": admin"; then
                echo "El usuario pertenece al grupo admin, continuamos..."
        else
                echo "El usuario no es administrador"
                echo "Contacte con coodinador/a TDE"
                echo "para instalar apps en el sistema"
                notify-send "El usuario no es administrador"
                notify-send "Contacte con coodinador/a TDE"
                notify-send "para instalar apps en el sistema"
                exit
        fi
}

# Función que repara las actualizaciones de cga-update-manager
# por alguna razón en las versiones previas de la versión "plus"
# muestra un error

function fixCgaupdate {

	if [ -f "/var/log/cga-update-manager/cga-updater.log" ]; then
	
		echo "CGA-update-manager existente"
	else
		sudo mkdir -p /var/log/cga-update-manager/
		sudo touch /var/log/cga-update-manager/cga-updater.log
		sudo chmod 666 /var/log/cga-update-manager/cga-updater.log
		echo "CGA-update-manager reparado"
		notify-send "CGA-update-manager reparado"
	fi
}

# Función que repara el fondo de educaandos plus cuando es cambiado por cga para la versión oficial en alguna actualización.

function fixBackground {

		#echo "$bgsize"
	if [[ $bgsize = "524" ]]; then
		#echo "$bgsize"
		echo "fondo de pantalla apropiado"
	else
		#echo "$bgsize"
		#echo "tamaño innapropiado"
		notify-send "Fondo de pantalla incorrecto, corrigiendo..."
		sudo wget https://github.com/aosucas499/guadalinex/raw/main/isobuilder/eggs/educaandos_wallpaper-plus.png -O /tmp/educaandos_wallpaper-plus.png
		sudo cp /tmp/educaandos_wallpaper-plus.png /usr/share/backgrounds/educaandos_wallpaper.png
	fi
}	

function arduinoGroup {

	if groups $USER | grep -q "dialout"; then
		echo "El usuario pertenece al grupo dialout"
	else
		echo "El usuario no pertenece al grupo, corrigiendo..."
		notify-send "El usuario no pertenece al grupo, corrigiendo..."
		sudo usermod -a -G dialout $USER
	fi
}

# Función para descargar repositorio en caso de que no exista en el sistema.
# Por ejemplo, en el primer inicio. También instala la app en el sistema.

function installOnsystem {

	if [ -f "/usr/bin/apps-educaandos" ]; then
	
		descargarRepo
	else
		cd /home/$USER
		echo ""
		echo "Descargando APP, espere unos segundos"
		echo ""
		notify-send "Descargando APP, espere unos segundos"
		git clone --branch $branch $gitguadalinex
		sudo cp guadalinex/src/AndaTuz2.svg /usr/share/icons/
		sudo cp guadalinex/src/apps-educaandos.desktop /usr/share/applications
		sudo cp guadalinex/src/apps-educaandos /usr/bin
		echo ""
		echo "Ejecútela desde el menú Herramientas del Sistema"
		echo ""
		notify-send "Ejecútela desde el menú Herramientas del Sistema"
		exit
		
	fi
	
}

# Función para descargar repositorio en caso de que no exista la carpeta del proyecto en el sistema.
# Por ejemplo, en el primer inicio. También instala la app en el sistema.

function descargarRepo {

	if [ -d "$gitfolder" ]; then
		updateRepo
	else
		cd /home/$USER
		echo ""
		echo "Descargando APP, espere unos segundos"
		echo ""
		notify-send "Descargando APP, espere unos segundos"
		git clone --branch $branch $gitguadalinex
		sudo cp guadalinex/src/AndaTuz2.svg /usr/share/icons/
		sudo cp guadalinex/src/apps-educaandos.desktop /usr/share/applications
		sudo cp guadalinex/src/apps-educaandos /usr/bin
		echo ""
		echo "Ejecútela desde el menú Herramientas del Sistema"
		echo ""
		notify-send "Ejecútela desde el menú Herramientas del Sistema"
		exit
	fi
			
}


# Función para actualizar apps-guadalinex-20 
# En el caso de que se haya modificado o borrado algún archivo de la carpeta local del sistema.
# Y en el caso de que se haya modificado o borrado algún archivo en el repositorio remoto.

function updateRepo {

	cd $gitfolder
	if git diff-index --quiet HEAD --; then
		echo "Repo github presente"
		cd $gitfolder
		# Actualiza siempre la carpeta local con respecto al remoto
		git pull
		echo ""
		echo ""
		sleep 3
		echo ""
		# Copia siempre la versión actualizada del lanzador tras ser actualizado en el comando anterior.
		#sudo cp $gitfolder/src/apps-educaandos /usr/bin
		
	else
		echo ""
		echo "Actualizando APP, espere unos segundos"
		echo ""
		notify-send "Actualizando APP, espere unos segundos"
		cd /home/$USER
		sudo rm -r guadalinex
    		git clone --branch $branch $gitguadalinex
    		sudo cp guadalinex/src/AndaTuz2.svg /usr/share/icons/
		sudo cp guadalinex/src/apps-educaandos.desktop /usr/share/applications
		sudo cp guadalinex/src/apps-educaandos /usr/bin
		echo ""
		echo "Ejecútela desde el menú Herramientas del Sistema"
		echo ""
		notify-send "Ejecútela desde el menú Herramientas del Sistema"
		exit
	fi
}


# Función que lanza la aplicación apps-guadalinex-20

function execRepo {
	
	sh -c $gitfolder/apps-guadalinex-20
	
}

## Variables a ejecutar en el script
#
adminGroup
installOnsystem
fixCgaupdate
fixBackground
arduinoGroup
execRepo

